---
title: "Analysis of Lung Cancer Data"
author: "Guy Brock"
date: "January 16, 2018"
output:
  html_document:
    highlight: kate
    self_contained: yes
    theme: yeti
    toc: yes
  word_document:
    toc: yes
  pdf_document:
    keep_tex: yes
    toc: yes
---


```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library("RColorBrewer")
library("pROC")

```


# Objectives / Analyses 

The goal is to compare DSC samples from those with lung cancer to controls.  Various sub-analyses are specified below.  

1.       Controls vs. Active (baseline samples, no active therapy)

2.       Controls vs. Type (baseline samples, no active therapy).  Analysis by stage, smoking status, demographics, etc.
   
3.       Longitudinal analysis - we did not include a list for this as these can be pulled directly from the clinical sheet as any samples after the baseline samples included in the Active list.
 


# Results 


## Reading in the Data

The first step is just reading in the data. Some notes about the clinical data are below. 

- DSC data: "DOD Lung Ca set1-30 final list for GUY"
- Patient data: "Patient data for analysis - Guy 11.30.2017"
- Gabriela and I made a list of sample codes to make it easier for you to pull.  This is in the file "Samples codes for analysis - 11.30.2017

1.       Controls (most of these were collected through pulmonology and have codes 1 through 48 and do not appear in the patient data file from Melissa.  There are three others from Melissa with "C" or "L" codes and these appear in the patient data file from Melissa.  NOTE: the "C" code stands for Melissa's CDSR coding and the "L" code is for her Lung coding before they standardized to CDSR codes)

2.       Active - these are mostly baseline "01" samples but also some others: for example, if we did not receive the "01" or if the patient was having treatment.  We have also separated out at the bottom of the list those where there was an additional cancer listed (exclude?) or a history of another cancer (leave in as this is in past history?)

3.       Type of lung cancer - our three main groups are adeno, squamous and small cell lung cancer.  The other groups are NOS and large cell.  Here we have taken out those with an additional active cancer listed but left those with history of other cancers at the bottom of the lists

### Additional notes 12/08/17

1. For the active vs. benign control group, can we exclude all patients with other active cancer or history of cancer.  This is what you did for the analysis by type and it would seem best to do this for the active group.  To make this easy, Gabriela has edited the file and created updated files in the folder "Files for analysis - 12.07.2017" where there is a new file "Sample codes for analysis - 12.07.2017".

2. For the analysis by cancer type, Gabriela found some errors in the numbers for each stage from that in your analysis report compared to the clinical spreadsheet - small cell is correct but adeno is missing two samples with stage 1, one with stage 3 and one with stage 4.  For squamous, there are two samples missing for stage 1.  She has created new tabs in the file "Sample codes for analysis - 12.07.2017" with the sample codes and corresponding stages for adeno, squamous and small cell groups.

3. For smoking status, Gabriela also found some inconsistency with the numbers of samples compared to the tables in your analysis report.  She added this information to the file "Sample codes for analysis - 12.07.2017".


```{r readData}
####################################################################
## read in Data
####################################################################

####################################################################
## Clinical Data 
####################################################################

## Clinical data includes both CASES and CONTROLS now 
data.clin <- read.csv("Patient data for analysis - CASES AND CONTROLS - Guy 12.07.2017.csv", 
                      header = TRUE, na.strings = c("", " ", "NA"))
dim(data.clin)
## tail(data.clin)
names(data.clin)

## remove dash from study ID so can match up later
data.clin$Sample.ID <- gsub("-", "", data.clin$Sample.ID)

####################################################################
## Thermogram Data 
####################################################################

## The thermogram data is in two sets 
data.dsc <- read.csv("DOD Lung Ca set1-30 final list for GUY.csv", header = TRUE)
dim(data.dsc)

## Restrict plot to temperatures between 50 and 90
idx.keep <- which(data.dsc$Temperature..C > 45 & data.dsc$Temperature..C < 90)
length(idx.keep)
data.dsc <- data.dsc[idx.keep, ]
dim(data.dsc)

## Convert this to a matrix 
rownames(data.dsc) <- data.dsc$Temperature..C
data.dsc <- as.matrix(data.dsc[,-1])
dim(data.dsc)

## Restrict clinical data to only those with corresponding DSC data 
## Need to take out the 'X' in colnames of DSC
grep("X", colnames(data.dsc), value = TRUE)
colnames(data.dsc) <- gsub("X", "", colnames(data.dsc))

## need to rename some IDs, see below 
is(data.clin$Sample.ID)
data.clin$Sample.ID[which(data.clin$Sample.ID == "C076401")] <- "C76401" 
data.clin$Sample.ID[which(data.clin$Sample.ID == "C076402")] <- "C76402" 

idx.dsc <- which(data.clin$Sample.ID %in% colnames(data.dsc))
length(idx.dsc)
colnames(data.dsc)[which(!(colnames(data.dsc) %in% data.clin$Sample.ID))]
## C76401 and C76402 seem to be missing from clinical data
## I see, they are labeled "C076401" "C076402" in clinical data ... 
## after correction above only control samples are out ... 

data.clin <- data.clin[idx.dsc, ]
dim(data.clin)

####################################################################
## Control Group 
####################################################################

controls <- scan("controls_list.csv", what = "character")

data.clin$group <- "Lung Cancer"
data.clin$group[which(data.clin$Sample.ID %in% controls)] <- "Control"
table(data.clin$group)
## perfect 


dim(data.dsc)
dim(data.clin)
## both have 396 samples 


####################################################################
## order both datasets by sample ID 
####################################################################

## Transpose data.dsc so that rows = samples, columns = temperatures
data.dsc <- t(data.dsc)
data.dsc <- data.dsc[order(rownames(data.dsc)), ]

data.clin <- data.clin[order(data.clin$Sample.ID),]
all.equal(data.clin$Sample.ID, rownames(data.dsc))

## Now can calculate summary statistics, PCs, etc. for ALL samples at 
## one time and store in data.clin 


```


## Summary metrics 

The next step is calculating the usual summary metrics we do for each sample.  

```{r calcSummaryMetrics}
####################################################################
## Need to also calculate usual summary metrics here ...
####################################################################


Temp <- seq(45.1, 89.9, by = 0.1)
length(Temp)
dim(data.dsc) ## columns should equal length of Temp

## Each statistic below calculated for each sample (= row of data.dsc)

## 1)	Total area (range 45-90 C)
data.clin$tot.area <- apply(data.dsc, 1, function(x) sum(x)*0.01)
## boxplot(tot.area ~ group)


## 2)	Maximum height
data.clin$max.height <- apply(data.dsc, 1, max)
## boxplot(max.height ~ group)


## 3)	Tmax (temperature of the peak maximum)
tmax.idx <- apply(data.dsc, 1, which.max)
tmp <- Temp[tmax.idx]
## tmp <- gsub("dsc.", "", tmp)
data.clin$tmax <- as.numeric(tmp)


## 4)	Width at half height
## NOTE - Need to find closest values on OPPOSITE sides of Tmax
half.hght <- data.clin$max.height/2
data.clin$width.half.hght <- numeric(nrow(data.dsc))  ## number subjects
for (i in 1:nrow(data.dsc)) {
    idx.tmax <- tmax.idx[i]
    res1 <- data.dsc[i,][1:idx.tmax] - half.hght[i]
    names(res1) <- Temp[1:idx.tmax]
    res2 <- data.dsc[i,][idx.tmax:nrow(data.dsc)] - half.hght[i]
    names(res2) <- Temp[idx.tmax:nrow(data.dsc)]
    temp1  <- names(which.min(abs(res1)))
    temp2  <- names(which.min(abs(res2)))
    temps <- as.numeric(c(temp1, temp2))
    data.clin$width.half.hght[i] <- diff(temps)
}
## boxplot(width.half.hght ~ group)

## 5)	Peak 1 Cpmax (heat capacity max of the first peak) (62-67?)
idx1 <- which(Temp == 62)
idx2 <- which(Temp == 67)
data.clin$peak1 <- apply(data.dsc[,idx1:idx2], 1, max)
## boxplot(peak1 ~ group)

## 6)	Peak 2 Cpmax (heat capacity max of the second peak) (69-73)
idx1 <- which(Temp == 69)
idx2 <- which(Temp == 73)
data.clin$peak2 <- apply(data.dsc[,idx1:idx2], 1, max)
## boxplot(peak2 ~ group)

## 8)	Peak 1 / Peak 2
data.clin$peak12.ratio <- data.clin$peak1/data.clin$peak2
## boxplot(peak12.ratio ~ group)

## 9)	TFM (first moment temperature)
data.clin$tfm <- apply(data.dsc, 1, function(x) sum(x*Temp)/sum(x))
## boxplot(tfm ~ group)


```


## Principal Components 

```{r PrinComp}
dsc.pc <- prcomp(data.dsc, retx=TRUE)
names(dsc.pc)
dim(dsc.pc$x)  ## the rotated data = PCs
dsc.pc$x[1:5, 1:5]
dim(dsc.pc$rotation) ## the PC loadings (used to calculate PCs)
length(dsc.pc$sdev)

plot(1:10, dsc.pc$sdev[1:10], main = "Scree plot for PCs of DSC thermograms",
     ylab = "Std Dev", xlab = "PC Number")
## Keep through component 6

## Total variation explained by comps 1-6?
tot.var <- sum(dsc.pc$sdev^2)
sum(dsc.pc$sdev[1:6]^2/tot.var)
## 97.5%

## Store the PCs in data.clin
all.equal(rownames(dsc.pc$x), data.clin$Sample.ID) 
## TRUE = in the same order
data.clin <- data.frame(data.clin, dsc.pc$x[,1:6])


## Now plot the principal component rotations (loadings)
## Just plot the first four
dim(dsc.pc$rotation)
length(Temp)
cols2 <- brewer.pal(4,"Dark2")
xlab <- expression(paste("Temperature (", displaystyle(degree), "C)", sep = ""))
matplot(Temp, dsc.pc$rotation[,1:4], lty = 1, type = "l", col = c(cols2), xlab = xlab, 
        ylab = "PC loading", main = "Plot of PC loadings", lwd = 2)
legend("topright", paste("PC", 1:4), lty = 1, col = c(cols2), lwd =2)


```


## Aim 1 - compare control and baseline lung cancer  

The first aim is to compare Controls vs. Active (baseline samples, no active therapy).  We are using the 'active list' provided in the Excel file 'Samples codes for analysis - 11.30.2017', but note some of the comments below (a few of those are NED or in active treatment, or later than baseline samples).


```{r}

####################################################################
## Active Disease Group 
####################################################################

## table of visit number
table(data.clin$Subject.Visit.Number)
## So use the 171 samples as the baseline for Aim 1? 
table(data.clin$Disease.Status.at.collection)
idx.v1 <- which(data.clin$Subject.Visit.Number == 1)
table(data.clin$Disease.Status.at.collection[idx.v1])
## most with active disease but some w/NED ... 
table(data.clin$Treatment.Status.at.collection[idx.v1])
## 142 treatment naive, 4 in treatment ... (25 w/Hx of previous TX?)

idx.aim1 <- which(data.clin$Subject.Visit.Number == 1 & 
                  data.clin$Disease.Status.at.collection %in% 
                    c("Active Disease", "New Primary", "Progression/Recurrence", "Stable Disease") & 
                    data.clin$Treatment.Status.at.collection %in% 
                   c("Baseline (Treatment Naive)", "Baseline (Hx of previous TX)"))
length(idx.aim1)
## 159 patients total ... 

## get the sample IDs 
aim1.ad.ids <- data.clin$Sample.ID[idx.aim1]                                                             
sum(rownames(data.dsc) %in% aim1.ad.ids)
## 159 match up 

####################################################################
## READ IN CASES FROM 'ACTIVE - 12.07.2017.CSV'
####################################################################
active <- read.csv("Active - 12.07.2017.csv", header = TRUE)
active.list <- active$Active
sum(rownames(data.dsc) %in% active.list)
## 149 
length(active.list)

length(intersect(aim1.ad.ids, active.list))
## 142
table(data.clin$Subject.Visit.Number[which(data.clin$Sample.ID %in% active.list)])
## some visit 2 and a visit 6
table(data.clin$Treatment.Status.at.collection[which(data.clin$Sample.ID %in% active.list)])
## one in treatment and one post-treatment 
table(data.clin$Disease.Status.at.collection[which(data.clin$Sample.ID %in% active.list)])

## Go ahead and use active.list for now 

####################################################################
## Control Group (use 'controls')
####################################################################

## controls <- scan("controls_list.csv", what = "character")

## CODE BELOW NOT NEEDED

## make a combined thermogram data with contols and active disease for Aim 1
## therm.aim1 <- data.dsc[,c(which(colnames(data.dsc) %in% controls),  ## controls first  
##                           which(colnames(data.dsc) %in% active.list))]
## dim(therm.aim1)


####################################################################
## CONTROL  GROUP : 51 SAMPLES 
## LUNG CA  GROUP : 166 SAMPLES 
####################################################################


```


```{r}
####################################################################
## quick check on smoking status
####################################################################

table(active$smoking.status)
table(data.clin$Smoking.Status.[data.clin$Sample.ID %in% active.list])
## should be fine
```

### Plot of Control vs Lung Cancer thermograms  

The next step is plotting the median thermogram for each group along with confidence bands (5% and 95%).    


```{r plotThermograms}

####################################################################
##
##        PLOT OF MEDIAN AND EMPIRICAL POINTWISE 90% CI
##
####################################################################

idx.controls <- which(rownames(data.dsc) %in% controls)
length(idx.controls)

idx.active <- which(rownames(data.dsc) %in% active.list)
length(idx.active)

idx.aim1 <- c(idx.controls, idx.active)

## AD
med.AD <- apply(data.dsc[idx.active, ], 2, median)
upp.AD <- apply(data.dsc[idx.active, ], 2, function(x) quantile(x, probs=0.95))
low.AD <- apply(data.dsc[idx.active, ], 2, function(x) quantile(x, probs=0.05))

## control
med.control <- apply(data.dsc[idx.controls, ], 2, median)
upp.control <- apply(data.dsc[idx.controls, ], 2, function(x) quantile(x, probs=0.95))
low.control <- apply(data.dsc[idx.controls, ], 2, function(x) quantile(x, probs=0.05))


## Floor lower values at zero
low.AD[low.AD < 0] <- 0
low.control[low.control < 0] <- 0


Ccol <- brewer.pal(9,"PuBu")[c(3,7)]##[c(6:3, 7, 3:6)]
Lcol <- brewer.pal(9,"RdPu")[c(3,7)]##[c(6:3, 7, 3:6)]
col2rgb(Ccol[1])
col2rgb(Lcol[1])

cols <- c(rgb(208, 209, 230,  100, maxColorValue=255), ## control, PuBu
          rgb(252, 197, 192,  100, maxColorValue=255)) ## AD, RdPu

## PREVIOUS COLORS 
## Ccol = brewer.pal(3,"YlGn")[c(2,3)]
## Lcol = brewer.pal(5,"OrRd")[c(2,5)]
## cols <- c(rgb(173, 221, 142,  100, maxColorValue=255), ## control, BuGn
##           rgb(253, 204, 138,  100, maxColorValue=255)) ## AD, OrRd


xvals <- seq(45.1, 89.9, by = 0.1)
length(xvals)
length(med.AD)

ymax <- max(c(upp.AD, upp.control))
ymin <- 0

## control
ylab <- expression(paste("Excess Spec Heat Capacity (cal/ ", displaystyle(degree), "C.g)", sep = ""))
xlab <- expression(paste("Temperature (", displaystyle(degree), "C)", sep = ""))
plot(xvals, med.control, ylim = c(ymin - 0.01, ymax + 0.01), type="n",
     xlab = xlab, ylab="")
mtext(ylab, side = 2, line = 2.5)
polygon(c(xvals, rev(xvals)),c(upp.control, rev(low.control)), col=cols[1], lty=2, border=NA)
lines(xvals, med.control, col=Ccol[2], lwd=2)

## Overlay AD
polygon(c(xvals, rev(xvals)),c(upp.AD, rev(low.AD)), col=cols[2], lty=2, border=NA)
lines(xvals, med.AD, col=Lcol[2], lwd=2)

legend("topleft", c("Control", "Lung Cancer"), lty=1, col = c(Ccol[2], Lcol[2]),
       bty = "n", lwd = 2, cex = 0.75)

## Not much difference here ... 
## Can we plot the underlying PC? Or plot separately? 



```




### Boxplots of summary metrics 


Boxplots of the summary metrics for the controls vs. the lung cancer cases.  

```{r SummaryMetricBoxplots}

lab1 <- "Area (cal/g)"
lab2 <- expression(paste("Width ( ", displaystyle(degree), "C )", sep = ""))
lab3 <- expression(paste("Height (cal/ ", displaystyle(degree), "C.g)", sep = ""))
lab4 <- expression(paste(plain(T)[plain(max)], " ( ", degree, "C )", sep = ""))
lab5 <- expression(paste(plain(T)[plain(FM)], " ( ", degree, "C )", sep = ""))
lab6 <- expression(paste(plain(C)[plain(p)]^plain(ex), " (Peak 1) (cal/ ", displaystyle(degree), "C.g)", sep = ""))
lab7 <- expression(paste(plain(C)[plain(p)]^plain(ex), " (Peak 2) (cal/ ", displaystyle(degree), "C.g)", sep = ""))
lab8 <- expression(paste(plain(C)[plain(p)]^plain(ex), " (Peak 1)/", plain(C)[plain(p)]^plain(ex), " (Peak 2)", sep = ""))


## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(width.half.hght ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(max.height ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(tmax ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(peak1 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(peak2 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(tfm ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(peak12.ratio ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences between controls and active lung cancer by the summary metrics are given below 

```{r TestSignifSummarMetrics}
metrics <- c("tot.area", "width.half.hght", "max.height", "tmax", "peak1", "peak2", "peak12.ratio", "tfm")
round(apply(data.clin[idx.aim1, metrics], 2, function(x) t.test(x ~ data.clin$group[idx.aim1])$p.value), 3)
## nothing significant

```


### ROC curves of summary metrics 

None of these are very good. 


```{r ROCSummaryMetrics}

## pdf("ROCSummaryMetrics.pdf")
cols <- brewer.pal(8,"Dark2")
roc1 <- multiclass.roc(group ~ tot.area, data = data.clin[idx.aim1,],
                       percent=TRUE, plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
                       lty=1, pch=1, main="ROC curves for thermogram summary metrics", cex.main = 1.5,
                       cex.axis=1.25, cex.lab = 1.5, col = cols[1])

roc2 <- multiclass.roc(group ~ width.half.hght, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent, col=cols[2],lty=2,pch=2)

roc3 <- multiclass.roc(group ~ max.height, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[3],lty=3,pch=3)

roc4 <- multiclass.roc(group ~ tmax, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[4],lty=4,pch=4)

roc5 <- multiclass.roc(group ~ peak1, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[5],lty=5,pch=5)

roc6 <- multiclass.roc(group ~ peak2, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[6],lty=6,pch=6)

roc7 <- multiclass.roc(group ~ peak12.ratio, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[7],lty=7,pch=7)

roc8 <- multiclass.roc(group ~ tfm, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[8],lty=8,pch=8)

legend(45, 50, inset=.05, metrics,
       lty=1:8, col=cols, bty = "n", horiz=FALSE, lwd = 2)

roc.all <- list(roc1, roc2, roc3, roc4, roc5, roc6, roc7, roc8)
aucs <- sapply(roc.all, auc)
aucs <- round(aucs/100, 2)
aucs

legend(18, 50, inset=.05, aucs, lty = 0, bty = "n")
text(10, 50, "AUC")

## dev.off()


```


### Boxplots of PCs 


Boxplots of the first six PCs by controls vs. active lung cancer 


```{r PCBoxplots}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC2 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC3 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC4 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC5 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC6 ~ group, border = 1:2, data = data.clin[idx.aim1,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences between controls and active lung cancer disease by PCs are given below 

```{r TestSignifDiffPCs}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.aim1, PCs], 2, function(x) t.test(x ~ data.clin$group[idx.aim1])$p.value), 3)
## PC2 and PC4 are showing some differences ... 

```


### ROC curves of PCs 

The best is PC2 with an AUC or C-index of 0.64. 


```{r ROCPCs}

pdf("ROCPCs.pdf")

cols <- brewer.pal(6,"Dark2")
roc1 <- multiclass.roc(group ~ PC1, data = data.clin[idx.aim1,],
                       percent=TRUE, plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
                       lty=1, pch=1, main="ROC curves for PCs", cex.main = 1.5,
                       cex.axis=1.25, cex.lab = 1.5, col = cols[1])

roc2 <- multiclass.roc(group ~ PC2, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent, col=cols[2],lty=2,pch=2)

roc3 <- multiclass.roc(group ~ PC3, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[3],lty=3,pch=3)

roc4 <- multiclass.roc(group ~ PC4, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[4],lty=4,pch=4)

roc5 <- multiclass.roc(group ~ PC5, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[5],lty=5,pch=5)

roc6 <- multiclass.roc(group ~ PC6, data = data.clin[idx.aim1,],
                       plot=TRUE, add=TRUE, percent=roc1$percent,col=cols[6],lty=6,pch=6)


legend(45, 50, inset=.05, PCs,
       lty=1:6, col=cols, bty = "n", horiz=FALSE, lwd = 2)

roc.all <- list(roc1, roc2, roc3, roc4, roc5, roc6)
aucs <- sapply(roc.all, auc)
aucs <- round(aucs/100, 2)
aucs

legend(18, 50, inset=.05, aucs, lty = 0, bty = "n")
text(10, 50, "AUC")

dev.off()


```





## Aim 2 - Analysis by stage, cancer type, smoking status

In this aim we explore the difference in DSC thermograms among lung cancer cases by stage, cancer type, and smoking status 



### Analysis by Cancer Histology (Adeno, Squamous, Small Cell, etc.)

Cancer subtype was read in from the 'Samples codes for analysis - 11.30.17' file.  

```{r}
table(data.clin$Histology.of.Primary.1)
table(data.clin$Histological.Subtype.1)
table(data.clin$Histological.Subtype.1[which(data.clin$Subject.Visit.Number == 1)])

## read in from 'Type - 12.07.2017.csv' file
type <- read.csv("Type - 12.07.2017.csv", header = TRUE, na.strings = c("", " "), stringsAsFactors = FALSE)
names(type)
## Adenos
adenos <- type$Adenocarcinoma[!is.na(type$Adenocarcinoma)]
length(adenos)
sum(adenos %in% data.clin$Sample.ID)
## Squamous
squamous <- type$Squamous[!is.na(type$Squamous)]
length(squamous)
sum(squamous %in% data.clin$Sample.ID)
## SCLC 
sclc <- type$SCLC[!is.na(type$SCLC)]
length(sclc)
sum(sclc %in% data.clin$Sample.ID)
## NOS 
nos <- type$NOS[!is.na(type$NOS)]
length(nos)
sum(nos %in% data.clin$Sample.ID)
## Large Cell 
large <- type$Large.cell[!is.na(type$Large.cell)]
length(large)
sum(large %in% data.clin$Sample.ID)

## Paste them all together
ids.type <- c(controls, adenos, squamous, sclc, nos, large)
length(ids.type)

idx.type <- which(data.clin$Sample.ID %in% ids.type)
length(idx.type)
table(data.clin$Histological.Subtype.1[idx.type])

## Need to create a factor for plotting (including 'controls' in subtype)
data.clin$Type <- factor(rep(NA, nrow(data.clin)), 
                         levels = c("Control", "Adeno", "Sq", "SCLC", "NOS", "Large"))
table(data.clin$Type)
data.clin$Type[which(data.clin$Sample.ID %in% controls)] <- "Control"
data.clin$Type[which(data.clin$Sample.ID %in% adenos)] <- "Adeno"
data.clin$Type[which(data.clin$Sample.ID %in% squamous)] <- "Sq"
data.clin$Type[which(data.clin$Sample.ID %in% sclc)] <- "SCLC"
data.clin$Type[which(data.clin$Sample.ID %in% nos)] <- "NOS"
data.clin$Type[which(data.clin$Sample.ID %in% large)] <- "Large"
table(data.clin$Type)


```

#### Plot of thermograms by type 

Plot of the median thermograms by type of disease 


```{r plotThermogramsType}

## AD
med.type <- apply(data.dsc[idx.type, ], 2, function(x) 
  tapply(x, factor(data.clin$Type[idx.type]), median))
med.type <- t(med.type)
med.type <- cbind(med.type)
head(med.type)

cols2 <- brewer.pal(6,"Dark2")[2:6]
cols2 <- c("black", cols2)
matplot(Temp, med.type, lty = 1, type = "l", col = cols2, xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by type of Disease", lwd = 2)
legend("topright", c(levels(data.clin$Type)), lty = 1, col = cols2, lwd =2)


```


#### Boxplots of summary metrics by type


Boxplots of the summary metrics for the lung cancer cases by type.

```{r MetricBoxplotsType}

## NOTE - can probably turn this into a function ... Should do for next time ... 

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by type of disease are given below.  There was nothing signficant. 

```{r}

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$Type[idx.type]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.type, metrics], 2, fx), 3)
## No significant differences here ... 

```

#### Boxplots of PCs 


Boxplots of the first six PCs by type of lung cancer 


```{r PCBoxplotsType}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
boxplot(PC2 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(PC3 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
boxplot(PC4 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(PC5 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
boxplot(PC6 ~ factor(Type), border = cols2, data = data.clin[idx.type,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by type of disease are given below.  There was nothing significant. 

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.type, PCs], 2, fx), 3)
## Nothing signficant

```



### Analysis by Stage - Adenocarcinoma


Analysis by stage was done separately within each of Adeno, Squamous and SCLC.

```{r}
table(data.clin$Current.Clinical.Stage)
## EX and LT correspond to the SCLC  

## Focus on baseline samples for Adenos
## idx.stage <- which(data.clin$Subject.Visit.Number == 1 & 
##                     data.clin$Type == "Adeno" &
##                     data.clin$Current.Clinical.Stage %in% c("1", "2", "3", "4"))
idx.stage <- which(data.clin$Sample.ID %in% adenos)
## append controls
idx.stage <- unique(c(idx.stage, which(data.clin$Sample.ID %in% controls)))
length(idx.stage)
table(data.clin$Current.Clinical.Stage[idx.stage])
data.clin$Adeno.Stage <- factor(data.clin$Current.Clinical.Stage, levels = c("Control", 1:4))
data.clin$Adeno.Stage[which(data.clin$Sample.ID %in% controls)] <- "Control"
table(data.clin$Adeno.Stage[idx.stage])


```

#### Plot of thermograms by stage 

Plot of the median thermograms by stage of disease 


```{r ThermogramsStageAdeno}

## AD
med.stage <- apply(data.dsc[idx.stage, ], 2, function(x) 
  tapply(x, factor(data.clin$Adeno.Stage[idx.stage]), median))
med.stage <- t(med.stage)
med.stage <- cbind(med.stage, med.control)
head(med.stage)

cols <- brewer.pal(8,"BuGn")[4:8]
cols2 <- brewer.pal(4,"Dark2")
cols2 <- c("black", cols2)
matplot(Temp, med.stage, lty = 1, type = "l", col = cols2, xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by Adenocarinoma Stage", lwd = 2)
legend("topright", levels(data.clin$Adeno.Stage), lty = 1, col = cols2, 
       title = "Disease Stage", lwd =2)

## Not quite sure how to interpret ... stage 3 seems most different

```


#### Boxplots of summary metrics by stage


Boxplots of the summary metrics for the lung cancer cases by stage.

```{r BoxplotsSummaryMetricsStageAdeno}

## NOTE - can probably turn this into a function ... Should do for next time ... 

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by stage of disease are given below.  There are a few significant results, I think related to differences between stage 3 and the others.  

```{r} 

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$Adeno.Stage[idx.stage]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.stage, metrics], 2, fx), 3)
## Nothing significant

```

#### Boxplots of PCs 


Boxplots of the first six PCs by stage of lung cancer 


```{r BoxplotsPCsStageAdeno}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC2 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC3 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC4 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC5 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC6 ~ factor(Adeno.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by stage of disease are given below.  PC2 seems to be the most different between the stages of disease.  

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.stage, PCs], 2, fx), 3)
## PC2 and PC4 are showing some differences ... 

```



### Analysis by Stage - Squamous



```{r}

## Focus on baseline samples for Squamous
## idx.stage <- which(data.clin$Subject.Visit.Number == 1 & 
##                     data.clin$Type == "Squamous" &
##                     data.clin$Current.Clinical.Stage %in% c("1", "2", "3", "4"))
idx.stage <- which(data.clin$Sample.ID %in% squamous)
## append controls
idx.stage <- unique(c(idx.stage, which(data.clin$Sample.ID %in% controls)))
length(idx.stage)
table(data.clin$Current.Clinical.Stage[idx.stage])
data.clin$Squamous.Stage <- factor(data.clin$Current.Clinical.Stage, levels = c("Control", 1:4))
data.clin$Squamous.Stage[which(data.clin$Sample.ID %in% controls)] <- "Control"
table(data.clin$Squamous.Stage[idx.stage])


```

#### Plot of thermograms by stage 

Plot of the median thermograms by stage of disease 


```{r ThermogramsStageSquamous}

## AD
med.stage <- apply(data.dsc[idx.stage, ], 2, function(x) 
  tapply(x, factor(data.clin$Squamous.Stage[idx.stage]), median))
med.stage <- t(med.stage)
med.stage <- cbind(med.stage, med.control)
head(med.stage)

cols <- brewer.pal(8,"BuGn")[4:8]
cols2 <- brewer.pal(4,"Dark2")
cols2 <- c("black", cols2)
matplot(Temp, med.stage, lty = 1, type = "l", col = cols2, xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by Squamous Stage", lwd = 2)
legend("topright", levels(data.clin$Squamous.Stage), lty = 1, col = cols2, 
       title = "Disease Stage", lwd =2)

## Not quite sure how to interpret ... stage 3 seems most different

```


#### Boxplots of summary metrics by stage


Boxplots of the summary metrics for the lung cancer cases by stage.

```{r BoxplotsSummaryMetricsStageSquamous}

## NOTE - can probably turn this into a function ... Should do for next time ... 

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by stage of disease are given below.  There are a few significant results, I think related to differences between stage 3 and the others.  

```{r} 

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$Squamous.Stage[idx.stage]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.stage, metrics], 2, fx), 3)
## Nothing significant

```

#### Boxplots of PCs 


Boxplots of the first six PCs by stage of lung cancer 


```{r BoxplotsPCsStageSquamous}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC2 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC3 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC4 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC5 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC6 ~ factor(Squamous.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by stage of disease are given below.  PC2 seems to be the most different between the stages of disease.  

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.stage, PCs], 2, fx), 3)
## PC2 and PC4 are showing some differences ... 

```





### Analysis by Stage - SCLC



```{r}

table(data.clin$Current.Clinical.Stage[data.clin$Type == "SCLC"])

## Focus on baseline samples for SCLC
## idx.stage <- which(data.clin$Subject.Visit.Number == 1 & 
##                     data.clin$Type == "SCLC" &
##                     data.clin$Current.Clinical.Stage %in% c("EX", "LT"))
idx.stage <- which(data.clin$Sample.ID %in% sclc)
## append controls
idx.stage <- unique(c(idx.stage, which(data.clin$Sample.ID %in% controls)))
length(idx.stage)
table(data.clin$Current.Clinical.Stage[idx.stage])
data.clin$SCLC.Stage <- factor(data.clin$Current.Clinical.Stage, levels = c("Control", "EX", "LT"))
data.clin$SCLC.Stage[which(data.clin$Sample.ID %in% controls)] <- "Control"
table(data.clin$SCLC.Stage[idx.stage])


```

#### Plot of thermograms by stage 

Plot of the median thermograms by stage of disease 


```{r ThermogramgsStageSCLC}

## AD
med.stage <- apply(data.dsc[idx.stage, ], 2, function(x) 
  tapply(x, factor(data.clin$SCLC.Stage[idx.stage]), median))
med.stage <- t(med.stage)
head(med.stage)

cols <- brewer.pal(8,"BuGn")[4:8]
cols2 <- brewer.pal(4,"Dark2")
cols2 <- c("black", cols2)
matplot(Temp, med.stage, lty = 1, type = "l", col = cols2, xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by SCLC Stage", lwd = 2)
legend("topright", levels(data.clin$SCLC.Stage), lty = 1, col = cols2, 
       title = "Disease Stage", lwd =2)

## Looks like EX and LT are both similarly different from Controls

```


#### Boxplots of summary metrics by stage


Boxplots of the summary metrics for the lung cancer cases by stage.

```{r BoxplotsSummaryMetricsStageSCLC}

## NOTE - can probably turn this into a function ... Should do for next time ... 

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by stage of disease are given below.  There are a few significant results, I think related to differences between stage 3 and the others.  

```{r} 

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$SCLC.Stage[idx.stage]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.stage, metrics], 2, fx), 3)
## Nothing significant

```

#### Boxplots of PCs 


Boxplots of the first six PCs by stage of lung cancer 


```{r BoxplotsPCsStageSCLC}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC2 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC3 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC4 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC5 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC6 ~ factor(SCLC.Stage), border = cols2, data = data.clin[idx.stage,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by stage of disease are given below.  PC2 is again showing some significance along with maybe PC5?  

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.stage, PCs], 2, fx), 3)
## PC2 and PC4 are showing some differences ... 

```





### Analysis by Smoking History 

Cancer subtype was read in from the 'Samples codes for analysis - 11.30.17' file.  Note that I merged the category 'Non-smoker**' with 'Never smoked'. 

```{r}
table(data.clin$Smoking.Status.)
table(data.clin$Smoking.Status.[which(data.clin$Subject.Visit.Number == 1)])
## Not sure what 'Non-smoker**'is, merge w/never smoked? 
## Make new variable w/just the 3 categories Current Smoker      Ex-smoker   Never smoked
data.clin$SmokingStatus <- factor(data.clin$Smoking.Status., 
                                  levels = c("Never smoked", "Ex-smoker", "Current Smoker"))

## 12-12-17 - Merging Non-smoker** with 'Never smoked' 
data.clin$SmokingStatus[which(data.clin$Smoking.Status. == "Non-smoker**")] <- "Never smoked"
data.clin$SmokingStatus[which(data.clin$Smoking.Status. == "Current smoker")] <- "Current Smoker"

## check 'active' list
table(data.clin$Smoking.Status.[data.clin$Sample.ID %in% active.list])
table(data.clin$SmokingStatus[data.clin$Sample.ID %in% active.list])
table(active$smoking.status)

table(data.clin$SmokingStatus[which(data.clin$Subject.Visit.Number == 1)])

## Cross-tabulate this w/case / controls status 
xtabs(~ SmokingStatus + group, data = data.clin)
## hmm only 1 control that is current smoker 

data.clin$SmokingStatusGroup <- interaction(data.clin$group, data.clin$SmokingStatus)
table(data.clin$SmokingStatusGroup)
## need shorter labels 
data.clin$SmokingStatusGroup <- factor(data.clin$SmokingStatusGroup, 
                                       labels = c("Cn.NS", "LC.NS", "Cn.ES", "LC.ES", "Cn.CS", "LC.CS"))
table(data.clin$SmokingStatusGroup)


##idx.smoking <- which(!(is.na(data.clin$SmokingStatus)) & data.clin$Subject.Visit.Number == 1)
##idx.smoking <- unique(c(idx.smoking, which(data.clin$Sample.ID %in% controls)))
##length(idx.smoking)
idx.smoking <- which(data.clin$Sample.ID %in% c(as.character(active.list), controls))
length(idx.smoking)

idx.controls <- which(data.clin$Sample.ID %in% controls)
table(data.clin$Smoking.Status.[idx.controls])

table(data.clin$SmokingStatusGroup[idx.smoking])


```

#### Plot of thermograms by smoking 

Plot of the median thermograms by smoking status and disease status.  Tough to tell where the differences lie.   


```{r plotThermogramsSmoking}

## AD
med.smoking <- apply(data.dsc[idx.smoking, ], 2, function(x) 
  tapply(x, factor(data.clin$SmokingStatusGroup[idx.smoking]), median))
med.smoking <- t(med.smoking)
head(med.smoking)

cols2 <- c(brewer.pal(3,"Blues")[2:3],
           brewer.pal(3,"Greens")[2:3],
           brewer.pal(3,"Oranges")[2:3])
  
           
matplot(Temp, med.smoking, lty = 1, type = "l", col = c(cols2), xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by smoking Status", lwd = 2)
legend("topright", levels(data.clin$SmokingStatusGroup), lty = 1, col = c(cols2), lwd =2, bty = "n")


```


#### Boxplots of summary metrics by smoking


Boxplots of the summary metrics for the lung cancer cases by smoking.

```{r MetricBoxplotsSmoking}

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by smoking of disease are given below.  There was nothing signficant. 

```{r}

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$SmokingStatusGroup[idx.smoking]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.smoking, metrics], 2, fx), 3)
## No significant differences here ... 

```

#### Boxplots of PCs 


Boxplots of the first six PCs by smoking of lung cancer 


```{r PCBoxplotsSmoking}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
boxplot(PC2 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(PC3 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
boxplot(PC4 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(PC5 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
boxplot(PC6 ~ SmokingStatusGroup, border = cols2, data = data.clin[idx.smoking,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by smoking status are given below.  Interesting that PC2 is showing some differences again.  

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.smoking, PCs], 2, fx), 3)
## PC2?

```


## Aim 3 - Longitudinal Samples 

For this Aim, we'll see whether PC2 is correlated with recurrence / disease status in the longitudinal samples.  We'll also look at whether the score from the classification models (which are not done yet) will correlate with longitudinal disease status. 


```{r}
table(data.clin$Subject.Visit.Number)
idx.rec <- which(data.clin$Subject.Visit.Number > 1)
table(data.clin$Disease.Status.at.collection[idx.rec])

## Add in controls
idx.rec <- unique(c(idx.rec, which(data.clin$Sample.ID %in% controls)))

## exclude Indeterminant and New Primary for now
data.clin$DiseaseStatus <- factor(data.clin$Disease.Status.at.collection, 
                                   levels = c("Control", "NED", "Stable Disease",
                                              "Active Disease", "Progression/Recurrence"))
data.clin$DiseaseStatus[which(data.clin$Sample.ID %in% controls)] <- "Control"
## Shorten the labels
data.clin$DiseaseStatus <- factor(data.clin$DiseaseStatus, labels = c("Control", "NED", "SD", "AD", "Pro/Rec")) 
table(data.clin$DiseaseStatus[idx.rec])

```



### Plot of thermograms by disease status at FU

Plot of the median thermograms by status of disease at follow-up visits.  Unfortunately the NED group looks less like the control population than the active disease groups. 


```{r ThermogramsDiseaseStatusFU}

## AD
med.status <- apply(data.dsc[idx.rec, ], 2, function(x) 
  tapply(x, factor(data.clin$DiseaseStatus[idx.rec]), median))
med.status <- t(med.status)
head(med.status)

cols <- brewer.pal(8,"BuGn")[4:8]
cols2 <- brewer.pal(4,"Dark2")
cols2 <- c("black", cols2)
matplot(Temp, med.status, lty = 1, type = "l", col = cols2, xlab = xlab, ylab = ylab, 
        main = "Median Thermograms by Disease Status at FU", lwd = 2)
legend("topright", levels(data.clin$DiseaseStatus), lty = 1, col = cols2, 
       title = "Disease Status", lwd =2)

## Looks like EX and LT are both similarly different from Controls

```


### Boxplots of summary metrics by status at FU


Boxplots of the summary metrics for the lung cancer status at FU.

```{r BoxplotsSummaryMetricsDiseaseStatusFU}

## NOTE - Use a 4x2 layout
par(mfrow = c(4, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(tot.area ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab1, side = 3, line = 0.1, cex = 0.8)
boxplot(width.half.hght ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab2, side = 3, line = 0.1, cex = 0.8)

## 2nd Row
boxplot(max.height ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab3, side = 3, line = 0.1, cex = 0.8)
boxplot(tmax ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab4, side = 3, line = 0.1, cex = 0.8)

## 3rd Row
boxplot(peak1 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab6, side = 3, line = 0.1, cex = 0.8)
boxplot(peak2 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab7, side = 3, line = 0.1, cex = 0.8)

## 4th Row
boxplot(tfm ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab5, side = 3, line = 0.1, cex = 0.8)
boxplot(peak12.ratio ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext(lab8, side = 3, line = 0.1, cex = 0.8)


```


Tests for statistical significance of differences of the summary metrics by disease status at FU are given below.  There are no significant results (peak2 < 0.05 but I don't count that after multiple comparisons adjustment).  

```{r} 

fx <- function(x) {
  res <- lm(x ~ factor(data.clin$DiseaseStatus[idx.rec]))
  return(anova(res)[1,5])
}
round(apply(data.clin[idx.rec, metrics], 2, fx), 3)
## Nothing significant

```

### Boxplots of PCs 


Boxplots of the first six PCs by disease status of lung cancer at FU


```{r BoxplotsPCsDiseaseStatusFU}

## NOTE - Use a 3x2 layout
par(mfrow = c(3, 2))

## 1st Row
par(mar = c(2.5, 2, 1.5, 1))
boxplot(PC1 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC1", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC2 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC2", side = 3, line = 0.1, cex = 0.8)

## 2nd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC3 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC3", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC4 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC4", side = 3, line = 0.1, cex = 0.8)

## 3rd Row
## par(mar = c(2.5, 4, 0.5, 1))
boxplot(PC5 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC5", side = 3, line = 0.1, cex = 0.8)
## par(mar = c(3, 3, 1, 1))
boxplot(PC6 ~ factor(DiseaseStatus), border = cols2, data = data.clin[idx.rec,])
mtext("PC6", side = 3, line = 0.1, cex = 0.8)

```


Tests for differences of PCs by disease status are given below.  PC2 is the most different but not statistically significant. 

```{r}
PCs <- paste("PC", 1:6, sep = "")
round(apply(data.clin[idx.rec, PCs], 2, fx), 3)

## Try an ordered factor for disease status 
table(data.clin$DiseaseStatus[idx.rec])
table(as.numeric(data.clin$DiseaseStatus[idx.rec]))
res <- lm(data.clin$PC2[idx.rec] ~ as.numeric(data.clin$DiseaseStatus[idx.rec]))
summary(res)
## If you look at disease status as an orderd factor then association is significant

```

## Data output for longitudinal 

Below all the summary metrics and PCs for the thermogram samples are output to a separate file for later analysis.  These are already saved in the R object **data.clin** so that is output to a .csv file.  The file contains all the clinical and summary DSC data for the 396 subjects with DSC data (including the 51 control subjects).  

```{r outputMetrics, eval=FALSE}
dim(data.clin)
dim(data.dsc)
write.csv(data.clin, file = "Lung Cancer Clinical and Summary DSC Data.csv", row.names = FALSE)
```

```{r saveData, eval=FALSE}
## save the RData file 
save.image("LungCancer.RData")
```




